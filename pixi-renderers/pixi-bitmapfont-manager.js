var gdjs;(function(l){const s=new l.Logger("Bitmap text"),n=GlobalPIXIModule.PIXI,m="GDJS-DEFAULT-BITMAP-FONT",h=5,d=(r,t)=>{const i=r.font;return r.font=t,n.BitmapFont.available[t]=r,delete n.BitmapFont.available[i],n.BitmapFont.available[t]};class f{constructor(t,i){this._pixiBitmapFontsInUse={};this._pixiBitmapFontsToUninstall=[];this._loadedFontsData={};this._defaultSlugFontName=null;this._resources=t,this._imageManager=i}getDefaultBitmapFont(){if(this._defaultSlugFontName!==null)return n.BitmapFont.available[this._defaultSlugFontName];const t="Arial",i=new n.TextStyle({fontFamily:t,fontSize:20,padding:5,align:"left",fill:"#ffffff",wordWrap:!0,lineHeight:20}),e=d(n.BitmapFont.from(t,i,{chars:[[" ","~"]]}),m);return this._defaultSlugFontName=e.font,e}setResources(t){this._resources=t}_markBitmapFontAsUsed(t){this._pixiBitmapFontsInUse[t]=this._pixiBitmapFontsInUse[t]||{objectsUsingTheFont:0},this._pixiBitmapFontsInUse[t].objectsUsingTheFont++;for(let i=0;i<this._pixiBitmapFontsToUninstall.length;)this._pixiBitmapFontsToUninstall[i]===t?this._pixiBitmapFontsToUninstall.splice(i,1):i++}releaseBitmapFont(t){if(t!==m){if(!this._pixiBitmapFontsInUse[t]){s.warn("BitmapFont with name "+t+" was tried to be released but was never marked as used.");return}if(this._pixiBitmapFontsInUse[t].objectsUsingTheFont--,this._pixiBitmapFontsInUse[t].objectsUsingTheFont===0&&(delete this._pixiBitmapFontsInUse[t],this._pixiBitmapFontsToUninstall.includes(t)||this._pixiBitmapFontsToUninstall.push(t),this._pixiBitmapFontsToUninstall.length>h)){const i=this._pixiBitmapFontsToUninstall.shift();n.BitmapFont.uninstall(i),s.log("Bitmap Text",'Uninstalled BitmapFont "'+i+'" from memory.')}}}obtainBitmapFont(t,i){const e=t+"@"+i;if(n.BitmapFont.available[e])return this._markBitmapFontAsUsed(e),n.BitmapFont.available[e];const a=this._loadedFontsData[t];if(!a)return s.warn('Could not find Bitmap Font for resource named "'+t+'". The default font will be used.'),this.getDefaultBitmapFont();const o=this._imageManager.getPIXITexture(i);try{const p=d(n.BitmapFont.install(a,o),e);return this._markBitmapFontAsUsed(e),p}catch(p){return s.error('Could not load the Bitmap Font for resource named "'+t+'". The default font will be used. Error is: '+p),this.getDefaultBitmapFont()}}loadBitmapFontData(t){const i=this._resources.filter(a=>a.kind==="bitmapFont"&&!a.disablePreload);if(i.length===0)return Promise.resolve([]);let e=0;return Promise.all(i.map(a=>fetch(a.file).then(o=>o.text()).then(o=>{this._loadedFontsData[a.name]=o}).catch(o=>{s.error("Can't fetch the bitmap font file "+a.file+", error: "+o)}).then(()=>{e++,t(e,i.length)})))}}l.PixiBitmapFontManager=f,l.BitmapFontManager=l.PixiBitmapFontManager})(gdjs||(gdjs={}));
//# sourceMappingURL=pixi-bitmapfont-manager.js.map
